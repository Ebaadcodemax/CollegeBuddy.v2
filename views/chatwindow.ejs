<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>
      Chat ‚Äî <%= chat.members.filter(m => m._id.toString() !== me.id).map(m =>
      m.name).join(', ') %>
    </title>

    <link rel="stylesheet" href="/css/chatWindow-ui.css">
    <link rel="stylesheet" href="/css/ui-base.css">
  </head>
  
  <body>
    <script>
  window.meId = "<%= me ? me.id : '' %>";
  window.chatId = "<%= typeof chat !== 'undefined' && chat ? chat._id : '' %>";
</script>
    <div class="topbar">
      <div class="title">
        Chat with <% chat.members.forEach(m => { if (m._id.toString() !== me.id)
        { %>
        <strong><%= m.name %></strong>
        <% } }) %>
        <span class="small"> ‚Äî <%= me.college %></span>
      </div>
      <div>
        <a href="/chat">‚Üê Back</a> &nbsp; | &nbsp;
        <a href="/auth/logout">Logout</a>
      </div>
    </div>

    <div class="container">
      <aside class="sidebar">
        <div style="font-weight: 600; margin-bottom: 8px">Conversation</div>
        <div class="small">Members</div>
        <% chat.members.forEach(m => { %>
        <div class="user-row">
          <div><%= m.name %></div>
          <div class="small">
            <%= (m._id.toString() === me.id) ? 'You' : m.email %>
          </div>
        </div>
        <% }) %>
      </aside>

      <main class="main">
       <div id="messages" class="messages">
  <% messages.forEach(m => { %>
    <div class="msg <%= (m.sender._id.toString() === me.id) ? 'me' : 'other' %>">
      <div class="sender"><%= (m.sender._id.toString() === me.id) ? 'You' : m.sender.name %></div>

      <% if (m.type === 'image' && m.imageUrl) { %>
        <img src="<%= m.imageUrl %>" alt="image" />
      <% } else { %>
        <div class="text"><%= m.text %></div>
      <% } %>

      <div class="time small"><%= new Date(m.createdAt).toLocaleTimeString() %></div>
    </div>
  <% }) %>
</div>


<div id="previewWrap" class="preview-wrap" style="display:none">
  <img id="previewImg" src="" alt="preview" />
  <div class="col">
    <div class="small">Uploading...</div>
    <div id="previewActions" class="row">
      <button id="removePreview" class="btn small ghost">Remove</button>
      <button id="sendPreview" class="btn primary small">Send</button>
    </div>
  </div>
</div>

<div class="composer">
  <div class="input">
    <input id="messageInput" placeholder="Type a message..." autocomplete="off" />
  </div>

  <div class="actions">
    <button id="attachBtn" class="icon-btn" title="Attach image">üì∑</button>
    <input id="imageInput" type="file" accept="image/*" style="display:none" />
    <button id="sendBtn" class="btn primary">Send</button>
  </div>
</div>
      </main>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/chat.js"></script>
    <script>

      const meId = "<%= me.id %>";
      const chatId = "<%= chat._id %>";

      const socket = io(); 
      socket.on("connect", () => {
        console.log("socket connected", socket.id);
      
        socket.emit("register", meId);
      
        socket.emit("joinChat", chatId);
      });

     
    function appendMessage(msg) {
  const wrap = document.createElement('div');
  const isMe = msg.sender && String(msg.sender._id) === meId;
  wrap.className = 'msg ' + (isMe ? 'me' : 'other');

  const who = document.createElement('div');
  who.style.fontWeight = '600';
  who.textContent = isMe ? 'You' : (msg.sender && msg.sender.name ? msg.sender.name : 'Unknown');

  const content = document.createElement('div');
  content.style.marginTop = '6px';

  if (msg.type === 'image' && msg.imageUrl) {
    const img = document.createElement('img');
    img.src = msg.imageUrl;
    img.style.maxWidth = '320px';
    img.style.borderRadius = '8px';
    content.appendChild(img);
  } else {
    content.textContent = msg.text || '';
  }

  const time = document.createElement('div');
  time.className = 'small';
  time.style.marginTop = '6px';
  time.textContent = new Date(msg.createdAt || Date.now()).toLocaleString();

  wrap.appendChild(who);
  wrap.appendChild(content);
  wrap.appendChild(time);

  const messages = document.getElementById('messages');
  messages.appendChild(wrap);
  messages.scrollTop = messages.scrollHeight - messages.clientHeight;
}

      socket.on("message", (msg) => {
        appendMessage(msg);
      });

      function sendMessage() {
        const input = document.getElementById("messageInput");
        const text = input.value.trim();
        if (!text) return;
     
        appendMessage({
          sender: { _id: meId, name: "You" },
          text,
          createdAt: Date.now(),
        });
        socket.emit("sendMessage", { chatId, text });
        input.value = "";
        input.focus();
      }

      document.getElementById("sendBtn").addEventListener("click", sendMessage);
      document
        .getElementById("messageInput")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") sendMessage();
        });

   
      window.addEventListener("load", () => {
        const messages = document.getElementById("messages");
        messages.scrollTop = messages.scrollHeight - messages.clientHeight;
      });
    </script>
  </body>
  <script src="/js/ui.js"></script>
  
which file to paste this into
</html>
